pipeline {
    agent any

    triggers {
        pollSCM('H/2 * * * *')  // Poll every 2 minutes
    }

    tools {
        nodejs "Node18"
    }

    environment {
        IMAGE_NAME = "janhavi001/nodejs-cloud-app"
    }

    stages {
        stage('Clone Repo') {
            steps {
                git branch: 'master',
                    credentialsId: 'github-creds',
                    url: 'https://github.com/Janhavi-j001/Case-study.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                echo 'ðŸ“¦ Dependencies will be installed during Docker build'
            }
        }

        stage('Run Tests') {
            steps {
                echo 'âœ… Tests configured - skipping for demo'
            }
        }

        stage('Docker Login, Build & Push') {
            steps {
                script {
                    def IMAGE_TAG = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
                    env.IMAGE_TAG = IMAGE_TAG
                    env.IMAGE = "${env.IMAGE_NAME}:${IMAGE_TAG}"
                    echo "ðŸ”– Using image tag: ${env.IMAGE_TAG}"
                }

                withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    sh '''
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        cd nodejs-cloud-case-study
                        docker build -t $IMAGE .
                        docker push $IMAGE
                    '''
                }
            }
        }

        stage('Cleanup Old Docker Images') {
            steps {
                echo 'ðŸ§¹ Cleaning up dangling Docker images...'
                sh 'docker image prune -f'
            }
        }

        stage('Terraform Deploy') {
            steps {
                dir('nodejs-cloud-case-study/terraform') {
                    sh '''
                        terraform init
                        terraform plan
                        terraform apply -auto-approve
                    '''
                }
            }
        }

        stage('Get Server IP') {
            steps {
                script {
                    dir('nodejs-cloud-case-study/terraform') {
                        env.SERVER_IP = sh(script: 'terraform output -raw instance_ip', returnStdout: true).trim()
                        echo "ðŸŒ Server IP: ${env.SERVER_IP}"
                    }
                }
            }
        }

        stage('Wait for Server') {
            steps {
                script {
                    dir('nodejs-cloud-case-study/terraform') {
                        env.SSH_KEY_PATH = sh(script: 'pwd', returnStdout: true).trim() + '/app_key.pem'
                    }
                }
                sh '''
                    echo "â³ Waiting for server to be ready..."
                    for i in $(seq 1 30); do
                        if ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ${SSH_KEY_PATH} ubuntu@${SERVER_IP} "echo 'Server ready'"; then
                            echo "âœ… Server is ready!"
                            break
                        fi
                        echo "Attempt $i/30 - Server not ready yet..."
                        sleep 15
                    done
                '''
            }
        }

        stage('Ansible Deploy') {
            steps {
                withEnv(["GIT_COMMIT=${env.IMAGE_TAG}"]) {
                    sh '''
                        cd nodejs-cloud-case-study
                        echo "ðŸš€ Deploying to server: ${SERVER_IP}"
                        
                        # Create dynamic inventory
                        cat > ansible/dynamic_inventory.ini << EOF
[webservers]
app-server ansible_host=${SERVER_IP} ansible_user=ubuntu

[all:vars]
ansible_ssh_private_key_file=${SSH_KEY_PATH}
ansible_ssh_common_args='-o StrictHostKeyChecking=no'
EOF
                        
                        # Create SSH directory and add server to known hosts
                        mkdir -p ~/.ssh
                        ssh-keyscan -H ${SERVER_IP} >> ~/.ssh/known_hosts 2>/dev/null || true
                        
                        # Deploy with Ansible
                        ansible-playbook -i ansible/dynamic_inventory.ini ansible/deploy.yml --private-key ${SSH_KEY_PATH}
                    '''
                }
            }
        }
    }
}